# Ory Hydra OAuth2 å•ç‚¹ç™»å½•æœåŠ¡

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Ory Hydra** çš„å®Œæ•´ OAuth2 å’Œ OpenID Connect å•ç‚¹ç™»å½•è§£å†³æ–¹æ¡ˆæ¼”ç¤ºé¡¹ç›®ã€‚

## ğŸ¯ é¡¹ç›®ç‰¹æ€§

- âœ… OAuth2 æˆæƒç æµç¨‹ (Authorization Code Flow)
- âœ… OpenID Connect æ”¯æŒ
- âœ… å®Œæ•´çš„ç™»å½•/åŒæ„/æ³¨é”€æµç¨‹
- âœ… è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œç®¡ç†
- âœ… JWT ID Token æ”¯æŒ
- âœ… CSRF ä¿æŠ¤ (State å‚æ•°)
- âœ… å¤šå®¢æˆ·ç«¯æ”¯æŒ
- âœ… ç¾è§‚çš„ç”¨æˆ·ç•Œé¢
- âœ… ä¸­æ–‡æœ¬åœ°åŒ–

## ğŸ—ï¸ æ¶æ„ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯åº”ç”¨     â”‚    â”‚   ç™»å½•åŒæ„åº”ç”¨   â”‚    â”‚   Ory Hydra     â”‚
â”‚  (Port: 5555)   â”‚â—„â”€â”€â–ºâ”‚  (Port: 3000)   â”‚â—„â”€â”€â–ºâ”‚  (Port: 4444)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚   PostgreSQL    â”‚
                                               â”‚  (Port: 5432)   â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜

1. **Ory Hydra** - OAuth2/OIDC æˆæƒæœåŠ¡å™¨
2. **ç™»å½•åŒæ„åº”ç”¨** - å¤„ç†ç”¨æˆ·ç™»å½•å’ŒæˆæƒåŒæ„
3. **å®¢æˆ·ç«¯åº”ç”¨** - æ¼”ç¤ºå¦‚ä½•é›†æˆ OAuth2 è®¤è¯
4. **PostgreSQL** - å­˜å‚¨ Hydra çš„é…ç½®å’Œä¼šè¯æ•°æ®

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

- Docker å’Œ Docker Compose
- Node.js 16+ (ç”¨äºè¿è¡Œç¤ºä¾‹åº”ç”¨)
- Git

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <your-repo-url>
cd hydra-demo
```

### 2. è®¾ç½®å’Œå¯åŠ¨æœåŠ¡

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/setup.sh

# è¿è¡Œè®¾ç½®è„šæœ¬
./scripts/setup.sh
```

è®¾ç½®è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- å¯åŠ¨ PostgreSQL æ•°æ®åº“
- è¿è¡Œ Hydra æ•°æ®åº“è¿ç§»
- å¯åŠ¨ Hydra æœåŠ¡
- åˆ›å»º OAuth2 å®¢æˆ·ç«¯
- å®‰è£…åº”ç”¨ä¾èµ–

### 3. å¯åŠ¨åº”ç”¨

**å¯åŠ¨ç™»å½•åŒæ„åº”ç”¨ï¼š**
```bash
cd login-consent-app
npm start
```

**å¯åŠ¨å®¢æˆ·ç«¯åº”ç”¨ï¼š**
```bash
cd client-app
npm start
```

### 4. è®¿é—®åº”ç”¨

- **å®¢æˆ·ç«¯åº”ç”¨**: http://localhost:5555
- **Hydra å…¬å…±API**: http://localhost:4444
- **Hydra ç®¡ç†API**: http://localhost:4445
- **ç™»å½•åŒæ„åº”ç”¨**: http://localhost:3000

## ğŸ”§ é…ç½®è¯´æ˜

### Hydra é…ç½® (hydra.yml)

ä¸»è¦é…ç½®é¡¹ï¼š

```yaml
# æ•°æ®åº“è¿æ¥
dsn: postgres://hydra:secret@localhost:5432/hydra?sslmode=disable

# æœåŠ¡ç«¯å£
serve:
  public:
    port: 4444  # å…¬å…±APIç«¯å£
  admin:
    port: 4445  # ç®¡ç†APIç«¯å£

# é‡è¦çš„URLé…ç½®
urls:
  login: http://localhost:3000/login      # ç™»å½•é¡µé¢
  consent: http://localhost:3000/consent  # åŒæ„é¡µé¢
  logout: http://localhost:3000/logout    # æ³¨é”€é¡µé¢
```

### OAuth2 å®¢æˆ·ç«¯é…ç½®

é»˜è®¤åˆ›å»ºäº†ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼š

```yaml
# æ¼”ç¤ºå®¢æˆ·ç«¯
å®¢æˆ·ç«¯ID: demo-client
å®¢æˆ·ç«¯å¯†é’¥: demo-secret
å›è°ƒURL: http://localhost:5555/callback

# æµ‹è¯•å®¢æˆ·ç«¯
å®¢æˆ·ç«¯ID: test-client
å®¢æˆ·ç«¯å¯†é’¥: test-secret
å›è°ƒURL: http://localhost:8080/callback
```

## ğŸ‘¥ æµ‹è¯•ç”¨æˆ·

ç³»ç»Ÿé¢„è®¾äº†ä»¥ä¸‹æµ‹è¯•ç”¨æˆ·ï¼š

| ç”¨æˆ·å | å¯†ç  | è§’è‰² |
|--------|------|------|
| admin | admin123 | ç®¡ç†å‘˜ |
| user1 | user123 | æ™®é€šç”¨æˆ· |
| user2 | user456 | æ™®é€šç”¨æˆ· |

## ğŸ”„ OAuth2 æµç¨‹è¯´æ˜

### 1. æˆæƒç æµç¨‹

```
1. ç”¨æˆ·è®¿é—®å®¢æˆ·ç«¯åº”ç”¨
2. å®¢æˆ·ç«¯é‡å®šå‘åˆ° Hydra æˆæƒç«¯ç‚¹
3. Hydra é‡å®šå‘åˆ°ç™»å½•é¡µé¢
4. ç”¨æˆ·è¾“å…¥å‡­æ®ï¼Œç™»å½•åº”ç”¨éªŒè¯å¹¶æ¥å—ç™»å½•
5. Hydra é‡å®šå‘åˆ°åŒæ„é¡µé¢
6. ç”¨æˆ·ç¡®è®¤æˆæƒï¼ŒåŒæ„åº”ç”¨æ¥å—åŒæ„
7. Hydra é‡å®šå‘å›å®¢æˆ·ç«¯å¹¶å¸¦ä¸Šæˆæƒç 
8. å®¢æˆ·ç«¯ä½¿ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ
9. å®¢æˆ·ç«¯ä½¿ç”¨è®¿é—®ä»¤ç‰Œè·å–ç”¨æˆ·ä¿¡æ¯
```

### 2. ä»¤ç‰Œç±»å‹

- **Access Token**: ç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æºçš„ JWT ä»¤ç‰Œ
- **Refresh Token**: ç”¨äºåˆ·æ–°è®¿é—®ä»¤ç‰Œçš„é•¿æœŸä»¤ç‰Œ
- **ID Token**: åŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„ JWT ä»¤ç‰Œ

## ğŸ—ï¸ ä¼šè¯å­˜å‚¨æ¶æ„

### ğŸ“Š å¤šæœåŠ¡å™¨ Session å­˜å‚¨è¯´æ˜

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæœ‰**å¤šä¸ªç‹¬ç«‹çš„æœåŠ¡å™¨**ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„ Session å­˜å‚¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼šè¯å­˜å‚¨æ¶æ„å›¾                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨ Browser â”‚    â”‚  å®¢æˆ·ç«¯åº”ç”¨æœåŠ¡å™¨  â”‚    â”‚   Hydra æœåŠ¡å™¨   â”‚
â”‚                â”‚    â”‚  (client-app)   â”‚    â”‚ (OAuth2 Server) â”‚
â”‚  åªå­˜ Cookie ID  â”‚â—„â”€â”€â–ºâ”‚   Port: 5555    â”‚â—„â”€â”€â–ºâ”‚   Port: 4444    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                       â”‚
                                â–¼                       â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Session å­˜å‚¨   â”‚    â”‚  Hydra Session  â”‚
                       â”‚                â”‚    â”‚                â”‚
                       â”‚ â€¢ access_token  â”‚    â”‚ â€¢ login_session â”‚
                       â”‚ â€¢ id_token      â”‚    â”‚ â€¢ consent_data  â”‚
                       â”‚ â€¢ user_info     â”‚    â”‚ â€¢ oauth_state   â”‚
                       â”‚ â€¢ oauth_state   â”‚    â”‚                â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ” Session å­˜å‚¨ä½ç½®è¯¦è§£

#### 1. **å®¢æˆ·ç«¯åº”ç”¨ Session** (æ‚¨å¸¸ç”¨çš„ `req.session`)
```javascript
// å­˜å‚¨ä½ç½®ï¼šå®¢æˆ·ç«¯åº”ç”¨æœåŠ¡å™¨ (localhost:5555)
req.session = {
  oauth_state: "uuid-generated-by-client",     // å®¢æˆ·ç«¯ç”Ÿæˆçš„çŠ¶æ€
  access_token: "eyJhbGci...",                // ä» Hydra è·å–çš„è®¿é—®ä»¤ç‰Œ
  id_token: "eyJhbGci...",                    // ä» Hydra è·å–çš„èº«ä»½ä»¤ç‰Œ
  refresh_token: "refresh_token_string",       // åˆ·æ–°ä»¤ç‰Œ
  user: {                                     // ç”¨æˆ·ä¿¡æ¯
    sub: "1",
    name: "ç®¡ç†å‘˜",
    email: "admin@example.com"
  }
}
```

**ç‰¹ç‚¹**ï¼š
- ğŸ  å­˜å‚¨åœ¨ï¼š**å®¢æˆ·ç«¯åº”ç”¨æœåŠ¡å™¨å†…å­˜ä¸­**
- ğŸ”„ ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨é‡å¯æ—¶ä¸¢å¤±
- ğŸ¯ ç”¨é€”ï¼šç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€å’Œä»¤ç‰Œ

#### 2. **Hydra Session** (OAuth2 æœåŠ¡å™¨å†…éƒ¨)
```javascript
// å­˜å‚¨ä½ç½®ï¼šHydra æœåŠ¡å™¨ + PostgreSQL æ•°æ®åº“
{
  login_session_id: "hydra-generated-id",     // Hydra ç”Ÿæˆçš„ç™»å½•ä¼šè¯
  subject: "1",                               // ç”¨æˆ·ä¸»ä½“
  login_challenge: "challenge-string",         // ç™»å½•æŒ‘æˆ˜
  consent_challenge: "consent-string",         // åŒæ„æŒ‘æˆ˜
  authenticated_at: "2023-12-01T10:00:00Z",  // è®¤è¯æ—¶é—´
  expires_at: "2023-12-01T11:00:00Z"         // è¿‡æœŸæ—¶é—´
}
```

**ç‰¹ç‚¹**ï¼š
- ğŸ  å­˜å‚¨åœ¨ï¼š**Hydra æœåŠ¡å™¨ + PostgreSQL æ•°æ®åº“**
- ğŸ”„ ç”Ÿå‘½å‘¨æœŸï¼šæŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒé›†ç¾¤
- ğŸ¯ ç”¨é€”ï¼šOAuth2 æµç¨‹çŠ¶æ€ç®¡ç†

#### 3. **ç™»å½•åŒæ„åº”ç”¨ Session** (å¯é€‰)
```javascript
// å­˜å‚¨ä½ç½®ï¼šç™»å½•åŒæ„åº”ç”¨æœåŠ¡å™¨ (localhost:3000)
// é€šå¸¸ç”¨äºä¸´æ—¶å­˜å‚¨ç™»å½•è¡¨å•æ•°æ®ç­‰
```

### ğŸ”„ å®Œæ•´çš„æ•°æ®æµç¨‹

```mermaid
sequenceDiagram
    participant Browser as æµè§ˆå™¨
    participant ClientApp as å®¢æˆ·ç«¯åº”ç”¨<br/>(Port: 5555)
    participant Hydra as Hydra æœåŠ¡å™¨<br/>(Port: 4444)
    participant LoginApp as ç™»å½•åŒæ„åº”ç”¨<br/>(Port: 3000)

    Browser->>ClientApp: 1. è®¿é—® /login
    ClientApp->>ClientApp: 2. ç”Ÿæˆ stateï¼Œå­˜å‚¨åœ¨è‡ªå·±çš„ session
    ClientApp->>Browser: 3. é‡å®šå‘åˆ° Hydra
    Browser->>Hydra: 4. OAuth2 æˆæƒè¯·æ±‚
    Hydra->>Hydra: 5. åˆ›å»º login_challengeï¼Œå­˜å‚¨åœ¨è‡ªå·±çš„æ•°æ®åº“
    Hydra->>Browser: 6. é‡å®šå‘åˆ°ç™»å½•é¡µé¢
    Browser->>LoginApp: 7. è®¿é—®ç™»å½•é¡µé¢
    LoginApp->>LoginApp: 8. å¯èƒ½æœ‰ä¸´æ—¶ session å­˜å‚¨è¡¨å•æ•°æ®
    LoginApp->>Hydra: 9. æ¥å—ç™»å½•è¯·æ±‚
    Hydra->>Browser: 10. é‡å®šå‘å›å®¢æˆ·ç«¯
    Browser->>ClientApp: 11. æºå¸¦æˆæƒç è¿”å›
    ClientApp->>ClientApp: 12. éªŒè¯ stateï¼ˆä»è‡ªå·±çš„ sessionï¼‰
    ClientApp->>Hydra: 13. äº¤æ¢ä»¤ç‰Œ
    Hydra->>ClientApp: 14. è¿”å› access_tokenã€id_token
    ClientApp->>ClientApp: 15. å­˜å‚¨ä»¤ç‰Œåˆ°è‡ªå·±çš„ session
```

### ï¿½ï¿½ å…³é”®åŒºåˆ«

| å­˜å‚¨ä½ç½® | æœåŠ¡å™¨ | å­˜å‚¨å†…å®¹ | è®¿é—®æ–¹å¼ | ç”Ÿå‘½å‘¨æœŸ |
|----------|--------|----------|----------|----------|
| **å®¢æˆ·ç«¯åº”ç”¨ Session** | localhost:5555 | ç”¨æˆ·ä»¤ç‰Œã€çŠ¶æ€ | `req.session.access_token` | åº”ç”¨é‡å¯ä¸¢å¤± |
| **Hydra Session** | localhost:4444 | OAuth2 æµç¨‹çŠ¶æ€ | Hydra å†…éƒ¨ç®¡ç† | æŒä¹…åŒ–å­˜å‚¨ |
| **æµè§ˆå™¨ Cookie** | æµè§ˆå™¨æœ¬åœ° | Session ID | è‡ªåŠ¨å‘é€ | è¿‡æœŸæ—¶é—´æ§åˆ¶ |

### ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

#### 1. **å®‰å…¨éš”ç¦»**
- å®¢æˆ·ç«¯åº”ç”¨åªç®¡ç†è‡ªå·±çš„ç”¨æˆ·çŠ¶æ€
- Hydra åªç®¡ç† OAuth2 åè®®ç›¸å…³çŠ¶æ€
- å„è‡ªè´Ÿè´£å„è‡ªçš„å®‰å…¨è¾¹ç•Œ

#### 2. **å¯æ‰©å±•æ€§**
- å¤šä¸ªå®¢æˆ·ç«¯åº”ç”¨å¯ä»¥è¿æ¥åŒä¸€ä¸ª Hydra
- æ¯ä¸ªå®¢æˆ·ç«¯åº”ç”¨ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„ç”¨æˆ·ä¼šè¯
- Hydra å¯ä»¥æœåŠ¡å¤šä¸ªä¸åŒçš„åº”ç”¨

#### 3. **èŒè´£åˆ†ç¦»**
```javascript
// å®¢æˆ·ç«¯åº”ç”¨è´Ÿè´£ï¼š
- ç”¨æˆ·ä½“éªŒç›¸å…³çš„ä¼šè¯ç®¡ç†
- ä»¤ç‰Œçš„æœ¬åœ°å­˜å‚¨å’Œä½¿ç”¨
- ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„çŠ¶æ€

// Hydra è´Ÿè´£ï¼š
- OAuth2 åè®®çš„æ ‡å‡†å®ç°
- å®‰å…¨çš„ä»¤ç‰Œé¢å‘å’ŒéªŒè¯
- è·¨åº”ç”¨çš„èº«ä»½è”åˆ
```

### ğŸ”§ å®é™…éªŒè¯æ–¹æ³•

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯è¿™ä¸ªæ¶æ„ï¼š

#### 1. **é‡å¯å®¢æˆ·ç«¯åº”ç”¨**
```bash
# é‡å¯å®¢æˆ·ç«¯åº”ç”¨
cd client-app
# Ctrl+C åœæ­¢ï¼Œç„¶åé‡æ–°å¯åŠ¨
npm start
# ç»“æœï¼šå®¢æˆ·ç«¯çš„ req.session æ•°æ®ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ç™»å½•
```

#### 2. **é‡å¯ Hydra æœåŠ¡**
```bash
# é‡å¯ Hydra æœåŠ¡
docker-compose restart hydra
# ç»“æœï¼šHydra çš„ session æ•°æ®ä¿ç•™ï¼ˆå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼‰
```

#### 3. **æŸ¥çœ‹æ•°æ®åº“**
```bash
# è¿æ¥åˆ° PostgreSQL æŸ¥çœ‹ Hydra çš„ä¼šè¯æ•°æ®
docker exec -it hydra-postgres psql -U hydra -d hydra
\dt  # æŸ¥çœ‹è¡¨ç»“æ„ï¼Œä¼šçœ‹åˆ° Hydra ç›¸å…³çš„ä¼šè¯è¡¨
```

## âœ… æ€»ç»“

**é‡è¦æ¾„æ¸…**ï¼š
- âŒ Session **ä¸æ˜¯**å­˜å‚¨åœ¨ OSS è®¤è¯ä¸­å¿ƒï¼ˆHydraï¼‰
- âœ… Session **æ˜¯**å­˜å‚¨åœ¨**å®¢æˆ·ç«¯åº”ç”¨è‡ªå·±çš„æœåŠ¡å™¨**ä¸Š
- ğŸ”„ Hydra æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¼šè¯ç®¡ç†æœºåˆ¶
- ğŸ—ï¸ è¿™æ˜¯ä¸€ä¸ª**å¤šæœåŠ¡å™¨åˆ†å¸ƒå¼æ¶æ„**ï¼Œæ¯ä¸ªæœåŠ¡å™¨ç®¡ç†è‡ªå·±çš„ä¼šè¯æ•°æ®

è¿™ç§è®¾è®¡ç¡®ä¿äº†å®‰å…¨æ€§ã€å¯æ‰©å±•æ€§å’ŒèŒè´£åˆ†ç¦»ï¼

## ğŸ“ é¡¹ç›®ç»“æ„

```
hydra-demo/
â”œâ”€â”€ hydra.yml                 # Hydra ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml        # Docker æœåŠ¡ç¼–æ’
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ setup.sh             # è‡ªåŠ¨è®¾ç½®è„šæœ¬
â”œâ”€â”€ login-consent-app/        # ç™»å½•åŒæ„åº”ç”¨
â”‚   â”œâ”€â”€ app.js               # ä¸»åº”ç”¨é€»è¾‘
â”‚   â”œâ”€â”€ package.json         # ä¾èµ–é…ç½®
â”‚   â””â”€â”€ views/               # EJS æ¨¡æ¿
â”‚       â”œâ”€â”€ login.ejs        # ç™»å½•é¡µé¢
â”‚       â”œâ”€â”€ consent.ejs      # åŒæ„é¡µé¢
â”‚       â””â”€â”€ error.ejs        # é”™è¯¯é¡µé¢
â”œâ”€â”€ client-app/              # å®¢æˆ·ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ client.js           # ä¸»åº”ç”¨é€»è¾‘
â”‚   â”œâ”€â”€ package.json        # ä¾èµ–é…ç½®
â”‚   â””â”€â”€ views/              # EJS æ¨¡æ¿
â”‚       â”œâ”€â”€ index.ejs       # é¦–é¡µ
â”‚       â”œâ”€â”€ profile.ejs     # ç”¨æˆ·èµ„æ–™é¡µ
â”‚       â””â”€â”€ error.ejs       # é”™è¯¯é¡µé¢
â””â”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£
```

## ğŸ”§ å¼€å‘å’Œè°ƒè¯•

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹ Hydra æ—¥å¿—
docker-compose logs -f hydra

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker-compose logs -f postgres
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯ Hydra æœåŠ¡
docker-compose restart hydra

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart
```

### ç®¡ç† OAuth2 å®¢æˆ·ç«¯

```bash
# åˆ—å‡ºæ‰€æœ‰å®¢æˆ·ç«¯
docker run --rm --network hydra-demo_hydra-net \
  oryd/hydra:v1.11.8 clients list --endpoint http://hydra:4445

# åˆ›å»ºæ–°å®¢æˆ·ç«¯
docker run --rm --network hydra-demo_hydra-net \
  oryd/hydra:v1.11.8 clients create \
  --endpoint http://hydra:4445 \
  --id my-client \
  --secret my-secret \
  --grant-types authorization_code,refresh_token \
  --response-types code \
  --scope openid,profile,email \
  --callbacks http://localhost:8080/callback

# åˆ é™¤å®¢æˆ·ç«¯
docker run --rm --network hydra-demo_hydra-net \
  oryd/hydra:v1.11.8 clients delete my-client --endpoint http://hydra:4445
```

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **æ›´æ”¹é»˜è®¤å¯†é’¥**ï¼š
   ```yaml
   secrets:
     system:
       - "your-production-secret-key"
     cookie:
       - "your-production-cookie-secret"
   ```

2. **å¯ç”¨ HTTPS**ï¼š
   ```yaml
   serve:
     public:
       tls:
         cert_path: /path/to/cert.pem
         key_path: /path/to/key.pem
   ```

3. **é…ç½®å®‰å…¨çš„æ•°æ®åº“è¿æ¥**ï¼š
   ```yaml
   dsn: postgres://user:password@host:5432/hydra?sslmode=require
   ```

4. **é™åˆ¶ CORS è®¾ç½®**ï¼š
   ```yaml
   serve:
     public:
       cors:
         allowed_origins:
           - "https://your-domain.com"
   ```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Docker æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tulpn | grep :4444
   
   # æ¸…ç†å¹¶é‡æ–°å¯åŠ¨
   docker-compose down -v
   docker-compose up -d
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
   docker-compose logs postgres
   
   # é‡æ–°è¿è¡Œè¿ç§»
   docker-compose run --rm hydra-migrate
   ```

3. **å®¢æˆ·ç«¯è®¤è¯å¤±è´¥**
   ```bash
   # éªŒè¯å®¢æˆ·ç«¯æ˜¯å¦å­˜åœ¨
   docker run --rm --network hydra-demo_hydra-net \
     oryd/hydra:v1.11.8 clients get demo-client --endpoint http://hydra:4445
   ```

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ—¥å¿—**ï¼š
   åœ¨ `hydra.yml` ä¸­è®¾ç½® `log.level: debug`

2. **æ£€æŸ¥ç½‘ç»œè¿æ¥**ï¼š
   ```bash
   # æµ‹è¯• Hydra å¥åº·çŠ¶æ€
   curl http://localhost:4444/health/ready
   
   # æµ‹è¯•ç®¡ç†API
   curl http://localhost:4445/health/ready
   ```

### ğŸ“Š HTTP 500 é”™è¯¯è§£å†³æ–¹æ¡ˆ

å¦‚æœè®¿é—® `http://localhost:3000/login?login_challenge=xxx` æ—¶é‡åˆ° 500 é”™è¯¯ï¼š

#### è‡ªåŠ¨è¯Šæ–­

**Windows ç”¨æˆ·:**
```powershell
.\scripts\diagnose.ps1
```

**Linux/Mac ç”¨æˆ·:**
```bash
chmod +x scripts/diagnose.sh
./scripts/diagnose.sh
```

#### æ‰‹åŠ¨æ’æŸ¥æ­¥éª¤

1. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
   ```bash
   # æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
   docker-compose ps
   
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -an | grep -E ":(3000|4444|4445|5432|5555)"
   ```

2. **æ£€æŸ¥ Hydra è¿æ¥**
   ```bash
   # æµ‹è¯• Hydra API (Windows ç”¨æˆ·è¯·ç”¨ PowerShell)
   curl http://localhost:4444/health/ready
   curl http://localhost:4445/health/ready
   ```

3. **æ£€æŸ¥ç™»å½•åŒæ„åº”ç”¨**
   ```bash
   # è¿›å…¥åº”ç”¨ç›®å½•
   cd login-consent-app
   
   # é‡å¯åº”ç”¨ (ä¼šæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—)
   npm start
   ```

4. **å¸¸è§é”™è¯¯ç±»å‹å’Œè§£å†³æ–¹æ¡ˆ**

   | é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
   |------|------|----------|
   | `ECONNREFUSED` | Hydra æœåŠ¡æœªå¯åŠ¨ | `docker-compose restart hydra` |
   | `login_challenge è¿‡æœŸ` | Challenge æ—¶æ•ˆæ€§ | é‡æ–°å¼€å§‹ OAuth2 æµç¨‹ |
   | `404 Not Found` | Challenge æ— æ•ˆ | ä½¿ç”¨æ­£ç¡®çš„å®¢æˆ·ç«¯å¼€å§‹æµç¨‹ |
   | `å®¢æˆ·ç«¯ä¸å­˜åœ¨` | OAuth2 å®¢æˆ·ç«¯æœªåˆ›å»º | è¿è¡Œ `./scripts/setup.sh` |

#### å¿«é€Ÿä¿®å¤

1. **é‡æ–°å¼€å§‹å®Œæ•´æµç¨‹**
   ```bash
   # 1. åœæ­¢æ‰€æœ‰æœåŠ¡
   docker-compose down
   
   # 2. é‡æ–°å¯åŠ¨
   docker-compose up -d
   
   # 3. ç­‰å¾…æœåŠ¡å¯åŠ¨ (çº¦ 30 ç§’)
   
   # 4. é‡æ–°è®¾ç½®
   ./scripts/setup.sh
   
   # 5. å¯åŠ¨åº”ç”¨
   cd login-consent-app && npm start
   cd client-app && npm start
   ```

2. **ä½¿ç”¨æµ‹è¯•é¡µé¢é‡æ–°å¼€å§‹**
   - æ‰“å¼€ `test-oauth-flow.html` æ–‡ä»¶
   - ç‚¹å‡» "å¼€å§‹ OAuth2 ç™»å½•" æŒ‰é’®
   - è¿™ä¼šç”Ÿæˆæ–°çš„ login_challenge

#### ç‰¹å®šé”™è¯¯å¤„ç†

**login_challenge è¿‡æœŸé”™è¯¯:**
```
é”™è¯¯: login_challenge å·²è¿‡æœŸï¼Œè¯·é‡æ–°å¼€å§‹ç™»å½•æµç¨‹
è§£å†³: è®¿é—® http://localhost:5555 é‡æ–°å¼€å§‹ OAuth2 æµç¨‹
```

**Hydra æœåŠ¡è¿æ¥å¤±è´¥:**
```
é”™è¯¯: ECONNREFUSED æˆ– ENOTFOUND
è§£å†³: 
1. æ£€æŸ¥ Docker æœåŠ¡: docker-compose ps
2. é‡å¯ Hydra: docker-compose restart hydra
3. æŸ¥çœ‹æ—¥å¿—: docker-compose logs hydra
```

**å®¢æˆ·ç«¯é…ç½®é”™è¯¯:**
```
é”™è¯¯: å®¢æˆ·ç«¯ä¸å­˜åœ¨æˆ–é…ç½®é”™è¯¯
è§£å†³: è¿è¡Œ ./scripts/setup.sh é‡æ–°åˆ›å»ºå®¢æˆ·ç«¯
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Ory Hydra å®˜æ–¹æ–‡æ¡£](https://www.ory.sh/hydra/docs/)
- [OAuth 2.0 RFC](https://tools.ietf.org/html/rfc6749)
- [OpenID Connect è§„èŒƒ](https://openid.net/connect/)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ï¿½ï¿½ è®¸å¯è¯

MIT License 